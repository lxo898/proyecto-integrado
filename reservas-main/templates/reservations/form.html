{% extends "base.html" %}
{% block title %}{{ form.instance.pk|yesno:"Editar reserva,Nueva reserva" }}{% endblock %}
{% block content %}

<section class="p-4 rounded-4 mb-4 text-white"
         style="background: linear-gradient(135deg,#198754,#0d6efd);">
  <h1 class="h3 m-0">{{ form.instance.pk|yesno:"‚úèÔ∏è Editar reserva,üóìÔ∏è Nueva reserva" }}</h1>
</section>

<style>
form input[type="text"], form input[type="datetime-local"], form textarea, form select {
  width: 100%; padding: .6rem .8rem; border: 1px solid #dee2e6;
  border-radius: .5rem; background: #fff;
}
#conflictAlert { display:none; }
#calendar { min-height: 520px; }
.legend-dot{ display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:.4rem; }
</style>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body">
    <div id="conflictAlert" class="alert alert-danger rounded-3 mb-4">
      ‚ö†Ô∏è Existe un conflicto de horario con otra reserva para este espacio. Ajusta el rango para continuar.
    </div>

    <form id="resForm" method="post" novalidate>
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Espacio</label>
          {{ form.space }}
          {% if form.space.errors %}<div class="text-danger small">{{ form.space.errors }}</div>{% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Inicio</label>
          {{ form.start }}
          {% if form.start.errors %}<div class="text-danger small">{{ form.start.errors }}</div>{% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label">T√©rmino</label>
          {{ form.end }}
          {% if form.end.errors %}<div class="text-danger small">{{ form.end.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="mt-3 mb-4">
        <label class="form-label">Motivo / prop√≥sito</label>
        {{ form.purpose }}
        {% if form.purpose.errors %}<div class="text-danger small">{{ form.purpose.errors }}</div>{% endif %}
      </div>

      <a href="{% url 'dashboard_user' %}" class="btn btn-outline-secondary rounded-3">Cancelar</a>
      <button id="submitBtn" type="submit" class="btn btn-primary rounded-3">Guardar</button>
    </form>
  </div>
</div>

<div class="card shadow-sm border-0 rounded-4 mt-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 m-0">Disponibilidad</h2>
      <div class="small text-muted">
        <span class="legend-dot" style="background:#198754"></span> Aprobada
        &nbsp;&nbsp;
        <span class="legend-dot" style="background:#ffc107"></span> Pendiente
      </div>
    </div>
    <div id="calendar"></div>
  </div>
</div>

<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
<!-- Locales para traducir a espa√±ol -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/locales-all.global.min.js"></script>

<script>
(function(){
  const availabilityUrl = "{% url 'availability_json' %}";
  const form = document.getElementById('resForm');
  const spaceEl = form.querySelector('[name$="space"]');
  const startEl = form.querySelector('[name$="start"]');
  const endEl   = form.querySelector('[name$="end"]');
  const alertEl = document.getElementById('conflictAlert');
  const submitBtn = document.getElementById('submitBtn');

  let calendar;
  let eventsCache = [];

  function toDate(val){
    if(!val) return null;
    const v = val.replace(' ', 'T');
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  function overlaps(aStart, aEnd, bStart, bEnd){
    return aStart < bEnd && aEnd > bStart;
  }

  async function loadEvents(){
    const space = spaceEl.value;
    if(!space){ eventsCache = []; renderCal([]); return; }
    const url = availabilityUrl + "?space=" + encodeURIComponent(space);
    const res = await fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}});
    eventsCache = res.ok ? await res.json() : [];
    renderCal(eventsCache);
    checkConflict();
  }

  function renderCal(events){
    const el = document.getElementById('calendar');
    if(!calendar){
      calendar = new FullCalendar.Calendar(el, {
        locale: 'es',            // ‚Üê idioma espa√±ol
        firstDay: 1,             // ‚Üê lunes como primer d√≠a
        initialView: 'timeGridWeek',
        slotMinTime: '07:00:00',
        slotMaxTime: '22:00:00',
        nowIndicator: true,
        height: 'auto',
        events: events.map(e => ({
          id: e.id,
          title: e.title,
          start: e.start,
          end: e.end,
          backgroundColor: e.backgroundColor,
          borderColor: e.borderColor,
          textColor: e.textColor,
        }))
      });
      calendar.render();
    } else {
      calendar.removeAllEvents();
      events.forEach(e => {
        calendar.addEvent({
          id: e.id,
          title: e.title,
          start: e.start,
          end: e.end,
          backgroundColor: e.backgroundColor,
          borderColor: e.borderColor,
          textColor: e.textColor,
        });
      });
    }
  }

  function checkConflict(){
    alertEl.style.display = 'none';
    submitBtn.disabled = false;

    const s = toDate(startEl.value);
    const e = toDate(endEl.value);
    if(!s || !e || !spaceEl.value) return;

    const conflict = eventsCache.some(ev => {
      const es = new Date(ev.start);
      const ee = new Date(ev.end);
      return overlaps(s, e, es, ee);
    });

    if(conflict){
      alertEl.style.display = 'block';
      submitBtn.disabled = true; // ‚Üê bloquea env√≠o si hay choque
    }
  }

  spaceEl?.addEventListener('change', loadEvents);
  startEl?.addEventListener('change', checkConflict);
  endEl?.addEventListener('change', checkConflict);

  loadEvents(); // inicial
})();
</script>
{% endblock %}
