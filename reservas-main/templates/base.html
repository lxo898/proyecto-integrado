{% load static %}
<!doctype html>
<html lang="es" data-bs-theme="">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Reservas Inacap 路 Sistema de Reservas{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  {% block extra_css %}{% endblock %}
  <style>
    /* ====== Paleta / tokens ====== */
    :root{
      --brand-red: #E2001A;
      --brand-red-dark: #8A0010;
      --radius: 1rem;
      --shadow: 0 6px 20px rgba(0,0,0,.08);

      /* Overrides Bootstrap primary (antes azul) */
      --bs-primary: var(--brand-red);
      --bs-primary-rgb: 226, 0, 26;
      --bs-link-color: var(--brand-red);
      --bs-link-hover-color: #b60015;
    }
    [data-bs-theme="dark"]{
      --bs-primary: var(--brand-red);
      --bs-primary-rgb: 226, 0, 26;
      --bs-link-color: var(--brand-red);
      --bs-link-hover-color: #ff5a73;
    }

    /* ====== Botones primarios a rojo ====== */
    .btn-primary{
      --bs-btn-color:#fff;
      --bs-btn-bg:var(--brand-red);
      --bs-btn-border-color:var(--brand-red);
      --bs-btn-hover-bg:#b60015;
      --bs-btn-hover-border-color:#b60015;
      --bs-btn-active-bg:#8A0010;
      --bs-btn-active-border-color:#8A0010;
      --bs-btn-disabled-bg:#f1a4ad;
      --bs-btn-disabled-border-color:#f1a4ad;
    }
    .btn-outline-primary{
      --bs-btn-color:var(--brand-red);
      --bs-btn-border-color:var(--brand-red);
      --bs-btn-hover-bg:var(--brand-red);
      --bs-btn-hover-border-color:var(--brand-red);
      --bs-btn-active-bg:#8A0010;
      --bs-btn-active-border-color:#8A0010;
    }

    /* ====== Estados activos en rojo ====== */
    .list-group-item.active{
      background-color: var(--brand-red) !important;
      border-color: var(--brand-red) !important;
      color:#fff !important;
    }
    .dropdown-item.active,
    .nav-pills .nav-link.active,
    .nav-pills .show>.nav-link,
    .pagination .page-item.active .page-link{
      background-color: var(--brand-red) !important;
      border-color: var(--brand-red) !important;
      color:#fff !important;
    }
    .nav-link.active{ color: var(--brand-red) !important; }
    .form-check-input:checked{
      background-color: var(--brand-red);
      border-color: var(--brand-red);
    }
    .badge.text-bg-primary,
    .bg-primary{ background-color: var(--brand-red) !important; }
    .border-primary{ border-color: var(--brand-red) !important; }
    .text-primary{ color: var(--brand-red) !important; }
    .link-primary{ color: var(--brand-red) !important; }

    /* ====== Utilidades de UI ====== */
    .rounded-4 { border-radius: var(--radius) !important; }
    .navbar-brand { font-weight: 800; letter-spacing: .2px; }
    .app-container { min-height: 72vh; }
    .alert-dismissible .btn-close { filter: none; }
    .inacap-hero{
      background: linear-gradient(135deg,var(--brand-red),var(--brand-red-dark));
      color: #fff;
    }
    .card { box-shadow: var(--shadow); }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-body border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2"
       href="{% if user.is_staff %}{% url 'dashboard_admin' %}{% else %}{% url 'dashboard_user' %}{% endif %}">
      Reservas Inacap
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
            aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto">
        {% if user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link {% if request.resolver_match.url_name == 'dashboard_user' or request.resolver_match.url_name == 'dashboard_admin' %}active{% endif %}"
               href="{% if user.is_staff %}{% url 'dashboard_admin' %}{% else %}{% url 'dashboard_user' %}{% endif %}">
              <i class="bi bi-house-door"></i> Inicio
            </a>
          </li>

          {% if user.is_staff %}
            <li class="nav-item">
              <a class="nav-link {% if request.resolver_match.url_name == 'spaces_list' %}active{% endif %}"
                 href="{% url 'spaces_list' %}">
                <i class="bi bi-building"></i> Espacios
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.resolver_match.url_name == 'resources_list' %}active{% endif %}"
                 href="{% url 'resources_list' %}">
                <i class="bi bi-tools"></i> Recursos
              </a>
            </li>
          {% endif %}

          <li class="nav-item">
            <a class="nav-link {% if request.resolver_match.url_name == 'history' %}active{% endif %}"
               href="{% url 'history' %}">
              <i class="bi bi-clock-history"></i> Historial
            </a>
          </li>
        {% endif %}
      </ul>

      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
        <!-- Dark mode toggle -->
        <li class="nav-item">
          <button id="themeToggle" class="btn btn-outline-secondary btn-sm rounded-3" type="button" title="Cambiar tema">
            <i id="themeIcon" class="bi bi-moon-stars"></i>
          </button>
        </li>

        {% if user.is_authenticated %}
          <!-- Bot贸n Notificaciones con badge -->
          <li class="nav-item">
            <a class="btn btn-outline-secondary rounded-3 position-relative"
               href="{% url 'notifications' %}">
              <i class="bi bi-bell"></i>
              <span class="d-none d-sm-inline">Notificaciones</span>
              {% if unread_notifications_count %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ unread_notifications_count }}
                  <span class="visually-hidden">nuevas</span>
                </span>
              {% endif %}
            </a>
          </li>

          <!-- Men煤 de usuario -->
          <li class="nav-item dropdown">
            <a class="btn btn-outline-primary dropdown-toggle rounded-3" href="#" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle"></i> {{ user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow">
              <li><span class="dropdown-item-text fw-bold">Reservas Inacap</span></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'profile' %}">
                <i class="bi bi-gear"></i> Perfil</a></li>
              {% if user.is_staff %}
                <li><a class="dropdown-item" href="{% url 'dashboard_admin' %}">
                  <i class="bi bi-speedometer"></i> Admin</a></li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'logout' %}" class="px-3 py-2">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger w-100 rounded-3">
                    <i class="bi bi-box-arrow-right"></i> Salir
                  </button>
                </form>
              </li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="btn btn-primary rounded-3" href="{% url 'login' %}">
              <i class="bi bi-box-arrow-in-right"></i> Ingresar
            </a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- MENSAJES -->
<div class="container mt-3">
  {% for msg in messages %}
    <div class="alert alert-{{ msg.tags }} alert-dismissible fade show rounded-4" role="alert">
      {{ msg }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
</div>

<!-- CONTENIDO -->
<main class="container py-4 app-container">
  {% block content %}{% endblock %}
</main>

<!-- FOOTER -->
<footer class="border-top py-4 mt-4">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div class="text-muted small">漏 {{ now|date:"Y" }} Reservas Inacap 路 Sistema de Reservas</div>
    <div class="text-muted small">
      <a class="text-reset text-decoration-none" href="#">T茅rminos</a> 路
      <a class="text-reset text-decoration-none" href="#">Privacidad</a> 路
      <a class="text-reset text-decoration-none" href="mailto:soporte@inacap.cl">Soporte</a>
    </div>
  </div>
</footer>

<!-- Toast de notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="notifToast"
       class="toast align-items-center text-bg-primary border-0"
       role="alert" aria-live="assertive" aria-atomic="true"
       data-bs-delay="7000">
    <div class="d-flex">
      <div class="toast-body">
         Tienes {{ unread_notifications_count }} notificaci贸n{{ unread_notifications_count|pluralize }} sin leer.
        <a href="{% url 'notifications' %}" class="text-white text-decoration-underline">Ver ahora</a>.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Utilidades globales -->
<script>
  // Tema con persistencia
  (function () {
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');

    const saved = localStorage.getItem('theme');
    if (saved === 'dark') root.setAttribute('data-bs-theme', 'dark');
    else root.removeAttribute('data-bs-theme');

    const refreshIcon = () => {
      const isDark = root.getAttribute('data-bs-theme') === 'dark';
      if (icon) icon.className = isDark ? 'bi bi-sun' : 'bi bi-moon-stars';
    };
    refreshIcon();

    btn?.addEventListener('click', function(){
      const isDark = root.getAttribute('data-bs-theme') === 'dark';
      if (isDark) {
        root.removeAttribute('data-bs-theme');
        localStorage.setItem('theme', '');
      } else {
        root.setAttribute('data-bs-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
      refreshIcon();
    });
  })();

  // Auto-Bootstrap widgets sin clases
  (function () {
    const q = (sel) => Array.from(document.querySelectorAll(sel));
    q('input:not([type=checkbox]):not([type=radio]):not(.form-control), textarea:not(.form-control), select:not(.form-select)')
      .forEach(el => {
        if (el.tagName === 'SELECT') el.classList.add('form-select');
        else el.classList.add('form-control');
      });
    q('input[type=checkbox]:not(.form-check-input)').forEach(el => el.classList.add('form-check-input'));
    q('input[type=radio]:not(.form-check-input)').forEach(el => el.classList.add('form-check-input'));
  })();

  // Mostrar toast si hay no le铆das
  (function(){
    var unread = parseInt('{{ unread_notifications_count|default:0 }}');
    if (!isNaN(unread) && unread > 0) {
      var el = document.getElementById('notifToast');
      if (el && window.bootstrap && window.bootstrap.Toast) {
        new bootstrap.Toast(el).show();
      }
    }
  })();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
